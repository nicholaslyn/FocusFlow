<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>FocusFlow — Focus Sessions & Habits</title>
<meta name="theme-color" content="#0ea5e9" />
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  /* ===== Techy Neon — premium visuals (mobile-first, decluttered) ===== */
  :root{
    --ink:#E9ECF5;           /* primary text */
    --muted:#A3B2C9;         /* secondary text */
    --acc1:#22d3ee;          /* cyan */
    --acc2:#7c3aed;          /* violet */
    --good:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --radius:18px; --shadow:0 18px 60px rgba(2,8,23,.45);
    --panel:rgba(17,24,39,.55); /* glass */
    --border:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;min-height:100vh;color:var(--ink);font:16px/1.7 'Plus Jakarta Sans',ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background:
      radial-gradient(1200px 700px at -20% -20%, rgba(34,211,238,.25) 0%, transparent 60%),
      radial-gradient(1000px 600px at 110% -10%, rgba(124,58,237,.22) 0%, transparent 60%),
      linear-gradient(180deg,#0b1020 0%, #070b16 60%, #040812 100%);
    -webkit-text-size-adjust: 100%;
  }
  a{color:inherit}
  header{position:sticky;top:0;z-index:20;background:rgba(4,8,18,.6);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  .hrow{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{font-weight:800;letter-spacing:.3px;font-size:18px;background:linear-gradient(90deg,var(--acc1),var(--acc2));-webkit-background-clip:text;background-clip:text;color:transparent}

  /* Tabs for mobile: one section at a time */
  .tabs{position:sticky;top:62px;z-index:15;display:flex;gap:8px;overflow:auto;padding:10px 16px;background:rgba(4,8,18,.55);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .tabs button{flex:1;min-width:120px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--ink);padding:10px 14px}
  .tabs button.active{background:linear-gradient(135deg,var(--acc1),var(--acc2));border-color:transparent;color:#fff}

  /* Layout: airy on desktop */
  main.wrap{display:grid;grid-template-columns:1fr;gap:18px}
  @media (min-width: 980px){ main.wrap{grid-template-columns:1.15fr .85fr; gap:20px} }

  /* Cards */
  .card{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .card + .card{margin-top:4px}
  .card::before{content:"";position:absolute;inset:-1px;border-radius:calc(var(--radius)+1px);padding:1px;background:linear-gradient(135deg,rgba(34,211,238,.45),rgba(124,58,237,.45));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}

  h2{margin:0 0 12px;font-size:clamp(18px,2vw,20px);color:#F3F6FF}
  .hint{color:var(--muted);font-size:13px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:12px}
  .grow{flex:1}

  /* Inputs & Buttons */
  input,select,button{border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--ink);padding:12px 14px;font:inherit;min-height:44px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;caret-color:var(--acc1)}
  input,textarea{width:100%;background:rgba(255,255,255,.03);-webkit-text-fill-color:var(--ink)}
  ::placeholder{color:var(--muted);opacity:.95}
  input[type=number]{-moz-appearance:textfield}
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{inputmode:numeric}
  button{cursor:pointer;transition:transform .18s ease, box-shadow .18s ease, background .18s ease}
  button.primary{background:linear-gradient(135deg,var(--acc1),var(--acc2));color:#fff;border-color:transparent;box-shadow:0 10px 30px rgba(34,211,238,.25), 0 6px 18px rgba(124,58,237,.25)}
  button.primary:hover{transform:translateY(-1px)}
  button.ghost{background:rgba(255,255,255,.06)}

  /* Timer controls become a neat grid on phones */
  #sec-timer .row:first-of-type{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  #sec-timer .row:first-of-type label{display:grid;grid-template-columns:1fr 96px;align-items:center}
  #sec-timer .row:first-of-type input{width:100%;text-align:center}
  @media (min-width:720px){#sec-timer .row:first-of-type{grid-template-columns:repeat(4,minmax(0,1fr))}}

  /* Timer */
  .timer-wrap{display:grid;place-items:center;margin:6px 0 12px}
  .ring{position:relative;width:min(82vw,360px);height:min(82vw,360px);pointer-events:none}
  .ring svg{position:absolute;inset:0;transform:rotate(-90deg)}
  .ring .clock{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:clamp(30px,10vw,60px)}
  .phase{color:var(--muted);font-size:13px;text-align:center;margin-top:6px}

  /* Goals & Habits list — cleaner */
  .list{display:flex;flex-direction:column;gap:10px}
  .item{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;padding:10px;flex-wrap:wrap}
  .item input[type="text"]{border:1px solid var(--border);border-radius:10px;padding:12px;background:rgba(255,255,255,.06);color:var(--ink);-webkit-text-fill-color:var(--ink);flex:1;min-width:180px}
  .item input[type="checkbox"]{accent-color:#7c3aed}
  .item button{min-width:44px}
  .nowrap{overflow-wrap:anywhere}
  .done input[type="text"]{text-decoration:line-through;opacity:.8}

  /* Habit day pills */
  .days{display:grid;grid-template-columns:repeat(7,36px);gap:8px}
  .pill{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.04);font-weight:700}
  .pill.on{background:linear-gradient(135deg,var(--acc1),var(--acc2));border-color:transparent;color:#fff}

  /* KPI & heatmap (7 x 5 so it never overflows) */
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpi{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.04)}
  .num{font-weight:800;font-size:clamp(18px,3.5vw,24px);background:linear-gradient(90deg,var(--acc1),var(--acc2));-webkit-background-clip:text;background-clip:text;color:transparent}
  .heat{display:grid;grid-template-columns:repeat(7, 14px);gap:6px;justify-content:flex-start}
  .cell{width:14px;height:14px;border-radius:3px;background:rgba(255,255,255,.06);border:1px solid var(--border)}
  .c1{background:#0ea5e955}.c2{background:#7dd3fc77}.c3{background:#60a5fa99}.c4{background:#a78bfaAA}

  /* Weekly table — compact & safe on mobile */
  table{width:100%;border-collapse:collapse;background:rgba(255,255,255,.04);border-radius:12px;overflow:hidden;table-layout:fixed;display:block;overflow-x:auto}
  thead,tbody,tr{display:table;width:100%}
  td,th{border-bottom:1px solid var(--border);padding:10px;white-space:nowrap}
  @media (max-width:420px){ td,th{padding:8px;font-size:13px} }

  canvas{width:100%;height:220px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px}

  /* Toasts & overlay */
  .toasts{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:60}
  .toast{background:rgba(17,24,39,.85);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px 12px;color:var(--ink)}
  .overlay{position:fixed;inset:0;background:rgba(2,8,23,.35);display:none;align-items:center;justify-content:center;z-index:100;pointer-events:none}
  .overlay .count{font:800 clamp(48px,14vw,84px)/1 'Plus Jakarta Sans';color:#fff;background:linear-gradient(135deg,rgba(34,211,238,.85),rgba(124,58,237,.85));padding:20px 28px;border-radius:16px;border:1px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,.45)}
</style>
</head>
<body>
<header>
  <div class="wrap hrow">
    <div class="brand">FocusFlow</div>
  </div>
  <div class="tabs" id="tabs">
    <button data-tab="timer" class="active">Focus Timer</button>
    <button data-tab="goals">Goals</button>
    <button data-tab="habits">Habits</button>
    <button data-tab="progress">Progress</button>
    <button data-tab="backup">Backup</button>
  </div>
</header>

<main class="wrap">
  <!-- Focus Sessions card -->
  <section id="sec-timer" class="card stack" data-panel="timer">
    <h2>Focus Sessions</h2>
    <div class="row">
      <label>Focus length <input id="focusMin" type="number" min="5" value="25" inputmode="numeric" autocomplete="off"> min</label>
      <label>Short break <input id="shortMin" type="number" min="1" value="5" inputmode="numeric" autocomplete="off"> min</label>
      <label>Long break <input id="longMin" type="number" min="5" value="15" inputmode="numeric" autocomplete="off"> min</label>
      <label>Long break every <input id="longEvery" type="number" min="2" value="4" inputmode="numeric" autocomplete="off"> sessions</label>
    </div>

    <div class="timer-wrap">
      <div class="ring">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <defs>
            <linearGradient id="ringGrad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#22d3ee"/>
              <stop offset="100%" stop-color="#7c3aed"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="46" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="8"/>
          <circle id="ringFg" cx="50" cy="50" r="46" fill="none" stroke="url(#ringGrad)" stroke-width="8" stroke-linecap="round" stroke-dasharray="289" stroke-dashoffset="0"/>
        </svg>
        <div id="clock" class="clock">25:00</div>
      </div>
      <div id="phase" class="phase">Ready</div>
    </div>

    <div class="row">
      <button id="start" class="ghost">Start</button>
      <button id="pause" class="ghost">Pause</button>
      <button id="reset" class="ghost">Reset</button>
      <button id="skip" class="ghost">Skip</button>
      <button id="complete" class="ghost">Complete Focus</button>
      <span id="sessionInfo" style="margin-left:auto" class="hint">0/4 cycles • Today: <span id="minsToday">0</span> min</span>
    </div>
    <div class="hint">Pomodoro = 25‑min focus + 5‑min break. Adjust lengths above.</div>
  </section>

  <!-- Daily Goals -->
  <section id="sec-goals" class="card stack" data-panel="goals">
    <h2>Daily Goals</h2>
    <div class="row"><input id="goalInput" class="grow nowrap" placeholder="Add a goal for today…"><button id="addGoal" class="primary">Add</button></div>
    <div id="goalList" class="list"></div>
  </section>

  <!-- Habits -->
  <section id="sec-habits" class="card stack" data-panel="habits">
    <h2>Habits (last 7 days)</h2>
    <div class="row">
      <input id="habitInput" class="grow nowrap" placeholder="Add habit (e.g., Read 20m)">
      <button id="addHabit" class="primary">Add</button>
    </div>
    <div id="habitList" class="list"></div>
  </section>

  <!-- Progress -->
  <section id="sec-progress" class="card stack" data-panel="progress">
    <h2>Progress — last 35 days</h2>
    <div class="kpis">
      <div class="kpi"><div class="num" id="kpiStreak">0</div><div class="hint">Current streak (days)</div></div>
      <div class="kpi"><div class="num" id="kpiToday">0</div><div class="hint">Focused minutes today</div></div>
      <div class="kpi"><div class="num" id="kpiWeek">0</div><div class="hint">Focused minutes this week</div></div>
    </div>
    <div id="heat" class="heat" aria-label="Streak heatmap"></div>
    <div class="row">
      <label>Today <input id="editTodayMins" type="number" min="0" inputmode="numeric" value="0"> min</label>
      <button id="saveTodayMins" class="ghost">Save</button>
      <button id="clearToday" class="ghost">Clear today</button>
      <button id="undoBtn" class="ghost">Undo last log</button>
    </div>
    <div class="hint">Tip: tap a number in the weekly table to edit it.</div>
    <table id="weekTable"><thead><tr><th>Date</th><th>Focused minutes</th></tr></thead><tbody></tbody></table>
    <canvas id="chart"></canvas>
  </section>

  <!-- Backup -->
  <section id="sec-backup" class="card stack" data-panel="backup">
    <h2>Backup</h2>
    <div class="row">
      <button id="exportBtn" class="ghost">Export (.json)</button>
      <button id="importBtn" class="ghost">Import (.json)</button>
      <span class="hint">Your data stays on this device.</span>
    </div>
  </section>
</main>

<div class="overlay" id="overlay"><div class="count" id="count">3</div></div>
<div class="toasts" id="toasts"></div>

<script>
// ====== Helpers & State ======
const K={settings:'ff_settings', habits:'ff_habits_v3', focus:'ff_focus_log_v3', goals:'ff_goals_v1'};
const S=JSON.parse(localStorage.getItem(K.settings)||'{}');
const habits=JSON.parse(localStorage.getItem(K.habits)||'[]');
const focusLog=JSON.parse(localStorage.getItem(K.focus)||'{}');
const goalsByDay=JSON.parse(localStorage.getItem(K.goals)||'{}');
const UNDO_K='ff_undo_v1';
const undoStack=JSON.parse(localStorage.getItem(UNDO_K)||'[]');
function saveUndo(){ localStorage.setItem(UNDO_K, JSON.stringify(undoStack)); }
const $=id=>document.getElementById(id); const todayStr=()=>new Date().toISOString().slice(0,10);
function save(){ localStorage.setItem(K.settings,JSON.stringify(S)); localStorage.setItem(K.habits,JSON.stringify(habits)); localStorage.setItem(K.focus,JSON.stringify(focusLog)); localStorage.setItem(K.goals,JSON.stringify(goalsByDay)); }
function toast(msg){ const box=$('toasts'); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; box.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; setTimeout(()=>t.remove(), 260); }, 2200); }

// ====== Tabs (mobile) ======
const tabs=$('tabs'); let currentTab='timer';
function setTab(tab){ currentTab=tab; for(const btn of tabs.querySelectorAll('button')) btn.classList.toggle('active', btn.dataset.tab===tab); for(const sec of document.querySelectorAll('[data-panel]')){ const show = sec.dataset.panel===tab || window.matchMedia('(min-width:980px)').matches; sec.style.display = show ? '' : 'none'; } }
setTab('timer'); tabs.addEventListener('click',(e)=>{ const b=e.target.closest('button[data-tab]'); if(!b) return; setTab(b.dataset.tab); });
window.addEventListener('resize', ()=>setTab(currentTab));

// ====== Focus Sessions (Pomodoro) ======
const focusMin=$('focusMin'), shortMin=$('shortMin'), longMin=$('longMin'), longEvery=$('longEvery');
[focusMin,shortMin,longMin,longEvery].forEach(el=>el.addEventListener('input',()=>{S.focusMin=+focusMin.value;S.shortMin=+shortMin.value;S.longMin=+longMin.value;S.longEvery=+longEvery.value;save();renderClock();}));
focusMin.value=S.focusMin||25; shortMin.value=S.shortMin||5; longMin.value=S.longMin||15; longEvery.value=S.longEvery||4;
let mode='focus', timer=null, remaining=0, cycles=0;
function duration(m){return (m==='focus'?+focusMin.value:m==='short'?+shortMin.value:+longMin.value)*60}
function mmss(s){const m=Math.floor(s/60),ss=(''+(s%60)).padStart(2,'0');return `${m}:${ss}`}
const ringLen=2*Math.PI*46; const ring=$('ringFg'); ring.setAttribute('stroke-dasharray', String(ringLen));
function setRingProgress(){ const total = (mode==='focus'?+focusMin.value:mode==='short'?+shortMin.value:+longMin.value)*60; const p = Math.max(0, Math.min(1, 1 - remaining/total)); ring.style.strokeDashoffset = String(ringLen * (1-p)); }
function renderClock(){ if(mode==='pause'&&remaining){$('clock').textContent=mmss(remaining);} else { remaining=duration(mode==='pause'?'focus':mode); $('clock').textContent=mmss(remaining);} $('phase').textContent=mode==='focus'?'Focus':mode==='short'?'Break':'Long break'; $('sessionInfo').innerHTML=`${cycles % (+longEvery.value||4)}/${+longEvery.value||4} cycles • Today: <span id="minsToday">${focusedToday()}</span> min`; setRingProgress(); }
function tick(){ remaining--; $('clock').textContent=mmss(remaining); setRingProgress(); if(remaining<=0){ phaseEnded(); }}
function start(){ if(timer) return; if(mode==='pause') mode='focus'; timer=setInterval(tick,1000); setActiveBtn($('start')); }
function pause(){ clearInterval(timer); timer=null; mode='pause'; setActiveBtn($('pause')); }
function reset(){ clearInterval(timer); timer=null; mode='focus'; cycles=0; renderClock(); setActiveBtn($('reset')); }
function skip(){ clearInterval(timer); timer=null; nextPhase(true); setActiveBtn($('skip')); }
function addFocusMinutes(mins){
  const t=todayStr();
  focusLog[t]=(focusLog[t]||0)+mins;
  undoStack.push({date:t, mins});
  if(undoStack.length>50) undoStack.shift();
  save(); saveUndo();
  toast(`+${mins} min logged`);
  updateUndoUI();
  syncEditToday();
});
  if(undoStack.length>50) undoStack.shift();
  save(); saveUndo();
  toast(`+${mins} min logged`);
  updateUndoUI();
  syncEditToday();

function focusedToday(){ return focusLog[todayStr()]||0; }
function phaseEnded(){
  clearInterval(timer); timer=null;
  if(mode==='focus'){
    addFocusMinutes(+focusMin.value); cycles++; mode = (cycles % (+longEvery.value||4)===0) ? 'long' : 'short';
    toast('Focus complete — tap Start to begin your break');
  } else {
    mode='focus'; toast('Break over — tap Start to begin focus');
  }
  save(); renderClock();
}
function nextPhase(skipped=false){ if(mode==='focus'){ if(!skipped) addFocusMinutes(+focusMin.value); cycles++; mode = (cycles % (+longEvery.value||4)===0) ? 'long' : 'short'; } else { mode='focus'; } save(); renderClock(); }
['start','pause','reset','skip','complete'].forEach(id=>{
  const fn = id==='start' ? start
           : id==='pause' ? pause
           : id==='reset' ? reset
           : id==='skip'  ? skip
           : ()=>{ addFocusMinutes(+focusMin.value); save(); updateViews(); };
  $(id).onclick = (e)=>{ e.preventDefault(); fn(); setActiveBtn($(id)); };
});
});
function setActiveBtn(el){ ['start','pause','reset','skip','complete'].forEach(id=>$(id).classList.remove('primary')); el.classList.add('primary'); }
renderClock();

// ====== Daily Goals ======
function goalsToday(){ const k=todayStr(); if(!goalsByDay[k]) goalsByDay[k]=[]; return goalsByDay[k]; }
function drawGoals(){ const host=$('goalList'); host.innerHTML=''; goalsToday().forEach(g=>{ const row=document.createElement('div'); row.className='item'+(g.done?' done':'');
  const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!g.done; cb.onchange=()=>{ g.done=cb.checked; row.classList.toggle('done', g.done); save(); };
  const txt=document.createElement('input'); txt.type='text'; txt.value=g.text; txt.placeholder='Goal'; txt.className='grow'; txt.oninput=()=>{ g.text=txt.value; save(); };
  const del=document.createElement('button'); del.textContent='✕'; del.title='Delete'; del.onclick=()=>{ const arr=goalsToday(); const i=arr.findIndex(x=>x.id===g.id); if(i>-1){ arr.splice(i,1); save(); drawGoals(); } };
  row.append(cb,txt,del); host.appendChild(row); }); }
$('addGoal').onclick=()=>{ const v=$('goalInput').value.trim(); if(!v) return; goalsToday().push({id:crypto.randomUUID(), text:v, done:false}); $('goalInput').value=''; save(); drawGoals(); toast('Goal added'); };
drawGoals();

// ====== Habits ======
function lastNDates(n){ const arr=[]; const now=new Date(); for(let i=n-1;i>=0;i--){ const d=new Date(now); d.setDate(now.getDate()-i); arr.push(d.toISOString().slice(0,10)); } return arr; }
function weekMonToSun(ref=new Date()){ const d=new Date(ref); const day=d.getDay(); const diff=(day+6)%7; d.setDate(d.getDate()-diff); const arr=[]; for(let i=0;i<7;i++){ const di=new Date(d); di.setDate(d.getDate()+i); arr.push(di.toISOString().slice(0,10)); } return arr; }
function dayLetter(iso){ try{ return new Date(iso).toLocaleDateString(undefined,{weekday:'short'}).slice(0,1).toUpperCase(); }catch(_){ return '·'; } }
function drawHabits(){ const host=$('habitList'); host.innerHTML=''; const days=weekMonToSun(); habits.forEach(h=>{
  const row=document.createElement('div'); row.className='item';
  const name=document.createElement('input'); name.type='text'; name.value=h.name; name.placeholder='Habit name'; name.className='grow'; name.oninput=()=>{h.name=name.value; save();};
  const grid=document.createElement('div'); grid.className='days';
  days.forEach(d=>{ const b=document.createElement('button'); b.className='pill'+(h.days&&h.days[d]?' on':''); b.setAttribute('aria-pressed', h.days&&h.days[d]?'true':'false'); b.title=d; b.textContent=dayLetter(d);
    b.onclick=()=>{h.days=h.days||{}; h.days[d]=!h.days[d]; b.classList.toggle('on'); b.setAttribute('aria-pressed', h.days[d]?'true':'false'); save(); updateViews();};
    grid.appendChild(b);
  });
  const del=document.createElement('button'); del.textContent='✕'; del.title='Delete'; del.onclick=()=>{ const i=habits.findIndex(x=>x.id===h.id); if(i>-1){habits.splice(i,1); save(); drawHabits(); updateViews();} };
  row.appendChild(name); row.appendChild(grid); row.appendChild(del); host.appendChild(row);
}); }
$('addHabit').onclick=()=>{ const v=$('habitInput').value.trim(); if(!v) return; habits.push({id:crypto.randomUUID(), name:v, days:{}}); $('habitInput').value=''; save(); drawHabits(); toast('Habit added'); };
drawHabits();

// ====== Progress & Weekly ======
function focusedLastNDays(n){ const out=[], now=new Date(); for(let i=n-1;i>=0;i--){ const d=new Date(now); d.setDate(now.getDate()-i); const k=d.toISOString().slice(0,10); out.push({k,mins:focusLog[k]||0}); } return out; }
function weekSum(){ return focusedLastNDays(7).reduce((a,b)=>a+b.mins,0); }
function buildHeat(){ const el=$('heat'); el.innerHTML=''; const data=focusedLastNDays(35); let cur=0; for(let i=data.length-1;i>=0;i--){ if(data[i].mins>0) cur++; else break; } $('kpiStreak').textContent=cur; $('kpiToday').textContent=focusedToday(); $('kpiWeek').textContent=weekSum(); data.forEach(({mins})=>{ const c=document.createElement('div'); c.className='cell ' + (mins>=60?'c4':mins>=30?'c3':mins>=10?'c2':mins>0?'c1':''); el.appendChild(c); }); }
function drawWeekTable(){
  const tb=$('weekTable').querySelector('tbody');
  tb.innerHTML='';
  focusedLastNDays(7).forEach(({k,mins})=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=k;
    const td2=document.createElement('td'); td2.textContent=mins; td2.style.cursor='pointer'; td2.title='Tap to edit';
    td2.onclick=()=>{
      const v=prompt(`Set focused minutes for ${k}`, String(focusLog[k]||0));
      if(v==null) return; const n=Math.max(0, +v || 0);
      focusLog[k]=n; save(); updateViews(); if(k===todayStr()){ const et=$('editTodayMins'); if(et) et.value=n; }
      toast('Updated');
    };
    tr.appendChild(td1); tr.appendChild(td2); tb.appendChild(tr);
  });
}
function drawChart(){ const cvs=$('chart'); const ctx=cvs.getContext('2d'); const data=focusedLastNDays(7).map(x=>x.mins); const w=cvs.width=cvs.clientWidth; const h=cvs.height=cvs.clientHeight; const pad=20; const max=Math.max(60, ...data, 1); const barW=(w-pad*2)/data.length*0.6; const step=(w-pad*2)/data.length; ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fillRect(pad, h-1-pad, w-pad*2, 1); ctx.fillStyle='#22d3ee'; data.forEach((v,i)=>{ const x=pad+i*step+(step-barW)/2; const bh=(h-pad*2)*v/max; const y=h-pad-bh; ctx.beginPath(); const r=6; ctx.moveTo(x, y+r); ctx.arcTo(x, y, x+r, y, r); ctx.lineTo(x+barW-r, y); ctx.arcTo(x+barW, y, x+barW, y+r, r); ctx.lineTo(x+barW, y+bh); ctx.lineTo(x, y+bh); ctx.closePath(); ctx.fill(); }); ctx.fillStyle='var(--muted)'; ctx.font='12px Plus Jakarta Sans, system-ui'; ctx.fillText('Focused minutes (last 7 days)', pad, 14); }
function updateViews(){
  buildHeat();
  drawWeekTable();
  drawChart();
  $('minsToday').textContent=focusedToday();
  syncEditToday();
  updateUndoUI();
}
updateViews();

// === Adjust/Undo controls ===
function updateUndoUI(){ const b=$('undoBtn'); if(!b) return; const last=undoStack[undoStack.length-1]; b.disabled=!last; b.textContent = last? `Undo last +${last.mins}m` : 'Undo last log'; }
function syncEditToday(){ const et=$('editTodayMins'); if(et) et.value = focusedToday(); }
const saveBtn=$('saveTodayMins'); if(saveBtn) saveBtn.onclick=()=>{ const n=Math.max(0, +$('editTodayMins').value||0); focusLog[todayStr()] = n; save(); updateViews(); toast('Today updated'); };
const clearBtn=$('clearToday'); if(clearBtn) clearBtn.onclick=()=>{ focusLog[todayStr()] = 0; save(); updateViews(); toast('Today cleared'); };
const undoBtnEl=$('undoBtn'); if(undoBtnEl) undoBtnEl.onclick=()=>{ const last=undoStack.pop(); if(!last){ toast('Nothing to undo'); return; } focusLog[last.date]=Math.max(0,(focusLog[last.date]||0)-last.mins); save(); saveUndo(); updateViews(); toast(`Removed ${last.mins} min`); };
updateUndoUI();

// ====== Export / Import ======
$('exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify({S,habits,focusLog,goalsByDay},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='focusflow-backup.json'; a.click(); toast('Backup saved'); };
$('importBtn').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); Object.assign(S,o.S||{}); habits.splice(0,habits.length,...(o.habits||[])); Object.keys(focusLog).forEach(k=>delete focusLog[k]); Object.assign(focusLog,o.focusLog||{}); Object.assign(goalsByDay,o.goalsByDay||{}); save(); location.reload(); }catch(e){ alert('Import failed: '+e.message); } }; r.readAsText(f); }; inp.click(); };

// ====== Shortcuts ======
document.addEventListener('keydown', (e)=>{ const tag=(e.target.tagName||'').toLowerCase(); if(tag==='input' || tag==='textarea') return; if(e.key.toLowerCase()==='s'){ if(timer) pause(); else start(); } if(e.key.toLowerCase()==='r'){ reset(); } if(e.key.toLowerCase()==='k'){ skip(); } if(e.key.toLowerCase()==='c'){ addFocusMinutes(+focusMin.value); save(); updateViews(); } if(e.key.toLowerCase()==='n'){ $('goalInput').focus(); }});

// Register service worker (kept for offline support)
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
</script>
</body>
</html>

